@page "/Course/Learn/{id:guid}"
@model OnlineLearningPlatformAss2.RazorWebApp.Pages.Course.LearnModel

@{
    ViewData["Title"] = Model.CourseLearn?.CourseTitle ?? "Course Learning";
    Layout = null; // Use a clean layout for learning
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - LearnHub</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Course Learning Styles -->
    <link rel="stylesheet" href="~/css/course-learn.css" asp-append-version="true" />
</head>

<body>
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger m-3">
            @Model.ErrorMessage
        </div>
    }

    @if (Model.CourseLearn != null)
    {
        <div class="learning-container">
            <!-- Sidebar with Course Content -->
            <div class="sidebar">
                <!-- Course Header -->
                <div class="course-header">
                    <h1 class="course-title">@Model.CourseLearn.CourseTitle</h1>
                    <div class="progress-info">
                        <small class="text-muted">@Model.CourseLearn.Progress% complete</small>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: @Model.CourseLearn.Progress%"></div>
                        </div>
                    </div>
                </div>

                <!-- Modules and Lessons -->
                <div class="modules-list">
                    @for (int moduleIndex = 0; moduleIndex < Model.CourseLearn.Modules.Count; moduleIndex++)
                    {
                        var module = Model.CourseLearn.Modules.ToList()[moduleIndex];
                        <div class="module-item">
                            <button class="module-header" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#module-@moduleIndex" aria-expanded="@(moduleIndex == 0 ? "true" : "false")">
                                <div>
                                    <h3 class="module-title">@module.Title</h3>
                                    <div class="module-meta">@module.Lessons.Count() lessons • @module.FormattedDuration</div>
                                </div>
                                <i class="bi bi-chevron-down"></i>
                            </button>
                            
                            <div class="collapse @(moduleIndex == 0 ? "show" : "")" id="module-@moduleIndex">
                                <div class="lessons-list">
                                    @foreach (var lesson in module.Lessons)
                                    {
                                        <div class="lesson-item @(lesson.IsCompleted ? "completed" : lesson.IsCurrent ? "current" : "")"
                                             onclick="selectLesson('@lesson.Id', '@lesson.Title')">
                                            <div class="lesson-title-section">
                                                <div class="lesson-icon @(lesson.IsCompleted ? "completed" : lesson.IsCurrent ? "current" : "pending")">
                                                    @if (lesson.IsCompleted)
                                                    {
                                                        <i class="bi bi-check"></i>
                                                    }
                                                    else if (lesson.IsCurrent)
                                                    {
                                                        <i class="bi bi-play-fill"></i>
                                                    }
                                                    else
                                                    {
                                                        <span>@lesson.OrderIndex</span>
                                                    }
                                                </div>
                                                <h4 class="lesson-title">@lesson.Title</h4>
                                            </div>
                                            <div class="lesson-duration">@lesson.FormattedDuration</div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Navigation -->
                <div class="navigation-controls">
                    <a href="javascript:history.back()" class="back-btn">
                        <i class="bi bi-arrow-left"></i>
                        Back to Course
                    </a>
                    <div class="nav-buttons">
                        <button class="btn btn-outline-secondary btn-sm me-2" onclick="previousLesson()">
                            <i class="bi bi-skip-backward"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="nextLesson()">
                            <i class="bi bi-skip-forward"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="content-area">
                <!-- Video Player -->
                <div class="video-container" id="videoContainer">
                    @if (!string.IsNullOrEmpty(Model.CourseLearn.CurrentLesson?.VideoUrl))
                    {
                        <iframe class="video-player"
                                src="@Model.CourseLearn.CurrentLesson.VideoUrl"
                                frameborder="0"
                                allowfullscreen>
                        </iframe>
                    }
                    else
                    {
                        <div class="d-flex align-items-center justify-content-center h-100 text-white">
                            <div class="text-center">
                                <i class="bi bi-play-circle" style="font-size: 4rem; margin-bottom: 1rem;"></i>
                                <h3>No Video Available</h3>
                                <p>This lesson contains text content only.</p>
                            </div>
                        </div>
                    }
                </div>

                <!-- Lesson Information -->
                <div class="lesson-info">
                    @if (Model.CourseLearn.CurrentLesson != null)
                    {
                        <h2 class="mb-3">@Model.CourseLearn.CurrentLesson.Title</h2>
                        <div class="lesson-content">
                            <p class="lesson-description">@Model.CourseLearn.CurrentLesson.Content</p>
                        </div>
                        <div class="lesson-actions">
                            <button class="btn btn-success" onclick="markAsCompleted()">
                                <i class="bi bi-check-circle me-2"></i>
                                Mark as Complete
                            </button>
                            <button class="btn btn-outline-primary" onclick="downloadResources()">
                                <i class="bi bi-download me-2"></i>
                                Download Resources
                            </button>
                            <button class="btn btn-outline-secondary" onclick="addNote()">
                                <i class="bi bi-journal-plus me-2"></i>
                                Add Note
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="container-fluid d-flex align-items-center justify-content-center" style="height: 100vh;">
            <div class="text-center">
                <h2>Course Not Found</h2>
                <p>The course you're trying to access could not be loaded.</p>
                <a asp-page="/Course/MyCourses" class="btn btn-primary">Back to My Courses</a>
            </div>
        </div>
    }

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        function selectLesson(lessonId, lessonTitle) {
            console.log('Selected lesson:', lessonId, lessonTitle);
            
            // Remove current class from all lessons
            document.querySelectorAll('.lesson-item').forEach(item => {
                item.classList.remove('current');
            });
            
            // Add current class to selected lesson
            event.target.closest('.lesson-item').classList.add('current');
            
            // Here you would typically load the lesson content
            // For now, just show a placeholder
            updateLessonContent(lessonTitle);
        }
        
        function updateLessonContent(title) {
            const videoContainer = document.getElementById('videoContainer');
            videoContainer.innerHTML = `
                <div class="d-flex align-items-center justify-content-center h-100 text-white">
                    <div class="text-center">
                        <i class="bi bi-play-circle" style="font-size: 4rem; margin-bottom: 1rem;"></i>
                        <h3>${title}</h3>
                        <p>Loading lesson content...</p>
                    </div>
                </div>
            `;
        }
        
        function markAsCompleted() {
            const currentLesson = document.querySelector('.lesson-item.current');
            if (currentLesson) {
                currentLesson.classList.add('completed');
                currentLesson.classList.remove('current');
                
                // Update icon
                const icon = currentLesson.querySelector('.lesson-icon');
                icon.className = 'lesson-icon completed';
                icon.innerHTML = '<i class="bi bi-check"></i>';
                
                // Move to next lesson
                nextLesson();
            }
        }
        
        function nextLesson() {
            const currentLesson = document.querySelector('.lesson-item.current');
            if (currentLesson) {
                const nextLesson = currentLesson.nextElementSibling;
                if (nextLesson && nextLesson.classList.contains('lesson-item')) {
                    nextLesson.click();
                }
            }
        }
        
        function previousLesson() {
            const currentLesson = document.querySelector('.lesson-item.current');
            if (currentLesson) {
                const prevLesson = currentLesson.previousElementSibling;
                if (prevLesson && prevLesson.classList.contains('lesson-item')) {
                    prevLesson.click();
                }
            }
        }
        
        function downloadResources() {
            alert('Resources downloaded successfully!');
        }
        
        function addNote() {
            const note = prompt('Add your note:');
            if (note) {
                alert('Note saved: ' + note);
            }
        }
        
        // Auto-save progress
        setInterval(function() {
            // Save current progress
            console.log('Auto-saving progress...');
        }, 30000); // Save every 30 seconds
    </script>
</body>
</html>
